<div class="container mt-4">
  <!-- Page Title -->
  <h2 class="page-title">
    <i class="fas fa-chart-line me-2"></i>Stats and Standings
  </h2>

  <!-- Navigation Tabs -->
  <div class="mb-4">
    <ul class="nav nav-tabs">
      <li class="nav-item">
        <a class="nav-link" 
           [class.active]="currentView === 'standings'"
           (click)="currentView = 'standings'">
          <i class="fas fa-trophy me-1"></i> Standings
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" 
           [class.active]="currentView === 'playerstats'"
           (click)="onPlayerStatsTabClick()">
          <i class="fas fa-users me-1"></i> Player Stats
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" 
           [class.active]="currentView === 'analytics'"
           (click)="currentView = 'analytics'">
          <i class="fas fa-chart-line me-1"></i> Team Analytics
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" 
           [class.active]="currentView === 'reports'"
           (click)="currentView = 'reports'">
          <i class="fas fa-file-export me-1"></i> Export Reports
        </a>
      </li>
    </ul>
  </div>

  <!-- Standings View -->
  <div *ngIf="currentView === 'standings'">
    <!-- League and View Selection -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
          <h5 class="mb-0">League Standings</h5>
          
          <div class="d-flex gap-3 align-items-center flex-wrap">
            <!-- View Type Selection -->
            <div class="btn-group">
              <button class="btn btn-sm" 
                      [class.btn-info]="standingsViewType === 'division'"
                      [class.btn-outline-info]="standingsViewType !== 'division'"
                      (click)="standingsViewType = 'division'; onStandingsViewChange()">
                <i class="fas fa-layer-group me-1"></i>By Division
              </button>
              <button class="btn btn-sm"
                      [class.btn-info]="standingsViewType === 'conference'"
                      [class.btn-outline-info]="standingsViewType !== 'conference'"
                      (click)="standingsViewType = 'conference'; onStandingsViewChange()">
                <i class="fas fa-sitemap me-1"></i>By Conference
              </button>
              <button class="btn btn-sm"
                      [class.btn-info]="standingsViewType === 'overall'"
                      [class.btn-outline-info]="standingsViewType !== 'overall'"
                      (click)="standingsViewType = 'overall'; onStandingsViewChange()">
                <i class="fas fa-globe me-1"></i>Overall
              </button>
            </div>

            <!-- League Selection -->
            <div class="btn-group">
              <button class="btn" 
                      [class.btn-primary]="selectedLeague === 'major'"
                      [class.btn-outline-primary]="selectedLeague !== 'major'"
                      (click)="selectedLeague = 'major'; onLeagueChange()">
                Major League
              </button>
              <button class="btn"
                      [class.btn-primary]="selectedLeague === 'minor'"
                      [class.btn-outline-primary]="selectedLeague !== 'minor'"
                      (click)="selectedLeague = 'minor'; onLeagueChange()">
                Minor League
              </button>
            </div>

            <!-- Management Buttons -->
            <div class="btn-group">
              <button *ngIf="canManagePlayoffs"
                      class="btn btn-outline-warning btn-sm" 
                      (click)="showPlayoffManager = !showPlayoffManager"
                      title="Manage playoff clinching status">
                <i class="fas fa-cog me-1"></i>Manage Playoffs
              </button>
              
              <!-- Refresh Button -->
              <button class="btn btn-outline-secondary btn-sm" 
                      (click)="refreshStandings()"
                      [disabled]="loadingStandings"
                      title="Refresh standings data">
                <i class="fas fa-sync-alt" [class.fa-spin]="loadingStandings"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Playoff Management Panel -->
    <div *ngIf="showPlayoffManager && canManagePlayoffs" class="card mb-4 border-warning">
      <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">
          <i class="fas fa-trophy me-2"></i>Playoff Status Management
        </h5>
      </div>
      <div class="card-body">
        <p class="mb-3">Set playoff clinching status for teams. This will add visual indicators to the standings.</p>
        
        <div class="row">
          <div *ngFor="let team of filteredTeams" class="col-md-4 mb-3">
            <div class="card">
              <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                  <img *ngIf="team.logoUrl" 
                       [src]="team.logoUrl" 
                       [alt]="team.name"
                       class="team-logo-small me-2">
                  <strong>{{ team.name }}</strong>
                </div>
                <select class="form-select form-select-sm" 
                        [value]="getTeamPlayoffStatus(team.id)"
                        (change)="updateTeamPlayoffStatus(team.id, $any($event.target).value)">
                  <option value="none">No Status</option>
                  <option value="league">League Championship Clinched (P)</option>
                  <option value="conference">Conference Championship Clinched (z)</option>
                  <option value="division">Division Championship Clinched (y)</option>
                  <option value="playoff">Playoff Spot Clinched (x)</option>
                  <option value="eliminated">Eliminated (e)</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Indicator -->
    <div *ngIf="loadingStandings" class="text-center py-4">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading standings...</span>
      </div>
    </div>

    <!-- Division View -->
    <div *ngIf="standingsViewType === 'division' && !loadingStandings">
      <div *ngFor="let conference of conferences" class="mb-4">
        <h3>{{ conference.name }}</h3>
        <div class="row">
          <div *ngFor="let division of conference.divisions" class="col-lg-4 mb-3">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">{{ division }}</h5>
              </div>
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead>
                    <tr>
                      <th>Team</th>
                      <th>GP</th>
                      <th>W</th>
                      <th>L</th>
                      <th>OTL</th>
                      <th>PTS</th>
                      <th>GF</th>
                      <th>GA</th>
                      <th>DIFF</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let team of getStandingsForDivision(conference.name, division)" 
                        [class]="getPlayoffStatusClass(team)">
                      <td>
                        <div class="d-flex align-items-center">
                          <img *ngIf="team.logoUrl" [src]="team.logoUrl" class="team-logo-small me-2" alt="{{ team.name }}">
                          <span>{{ team.name }}</span>
                          <span *ngIf="getPlayoffStatusBadge(team) as badge" [class]="badge.class" class="ms-1">
                            {{ badge.text }}
                          </span>
                        </div>
                      </td>
                      <td>{{ team.gamesPlayed }}</td>
                      <td>{{ team.wins }}</td>
                      <td>{{ team.losses }}</td>
                      <td>{{ team.overtimeLosses }}</td>
                      <td><strong>{{ team.points }}</strong></td>
                      <td>{{ team.goalsFor }}</td>
                      <td>{{ team.goalsAgainst }}</td>
                      <td [class.text-success]="team.goalDifferential > 0" [class.text-danger]="team.goalDifferential < 0">
                        {{ team.goalDifferential > 0 ? '+' : '' }}{{ team.goalDifferential }}
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Conference View -->
    <div *ngIf="standingsViewType === 'conference' && !loadingStandings">
      <div *ngFor="let conference of conferences" class="mb-4">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h4 class="mb-0">{{ conference.name }}</h4>
          </div>
          <div class="table-responsive">
            <table class="table table-striped mb-0">
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Team</th>
                  <th>GP</th>
                  <th>W</th>
                  <th>L</th>
                  <th>OTL</th>
                  <th>PTS</th>
                  <th>P%</th>
                  <th>GF</th>
                  <th>GA</th>
                  <th>DIFF</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let team of getStandingsForConference(conference.name); let i = index" 
                    [class]="getPlayoffStatusClass(team)">
                  <td>{{ i + 1 }}</td>
                  <td>
                    <div class="d-flex align-items-center">
                      <img *ngIf="team.logoUrl" [src]="team.logoUrl" class="team-logo-small me-2" alt="{{ team.name }}">
                      <span>{{ team.name }}</span>
                      <span *ngIf="getPlayoffStatusBadge(team) as badge" [class]="badge.class" class="ms-1">
                        {{ badge.text }}
                      </span>
                    </div>
                  </td>
                  <td>{{ team.gamesPlayed }}</td>
                  <td>{{ team.wins }}</td>
                  <td>{{ team.losses }}</td>
                  <td>{{ team.overtimeLosses }}</td>
                  <td><strong>{{ team.points }}</strong></td>
                  <td>{{ (team.pointPercentage * 100).toFixed(1) }}%</td>
                  <td>{{ team.goalsFor }}</td>
                  <td>{{ team.goalsAgainst }}</td>
                  <td [class.text-success]="team.goalDifferential > 0" [class.text-danger]="team.goalDifferential < 0">
                    {{ team.goalDifferential > 0 ? '+' : '' }}{{ team.goalDifferential }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Overall View -->
    <div *ngIf="standingsViewType === 'overall' && !loadingStandings">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h4 class="mb-0">{{ selectedLeague | titlecase }} League Overall Standings</h4>
        </div>
        <div class="table-responsive">
          <table class="table table-striped mb-0">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Team</th>
                <th>Conference</th>
                <th>Division</th>
                <th>GP</th>
                <th>W</th>
                <th>L</th>
                <th>OTL</th>
                <th>PTS</th>
                <th>P%</th>
                <th>GF</th>
                <th>GA</th>
                <th>DIFF</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let team of getOverallStandings(); let i = index" 
                  [class]="getPlayoffStatusClass(team)">
                <td>{{ i + 1 }}</td>
                <td>
                  <div class="d-flex align-items-center">
                    <img *ngIf="team.logoUrl" [src]="team.logoUrl" class="team-logo-small me-2" alt="{{ team.name }}">
                    <span>{{ team.name }}</span>
                    <span *ngIf="getPlayoffStatusBadge(team) as badge" [class]="badge.class" class="ms-1">
                      {{ badge.text }}
                    </span>
                  </div>
                </td>
                <td><small class="text-muted">{{ team.conference }}</small></td>
                <td><small class="text-muted">{{ team.division }}</small></td>
                <td>{{ team.gamesPlayed }}</td>
                <td>{{ team.wins }}</td>
                <td>{{ team.losses }}</td>
                <td>{{ team.overtimeLosses }}</td>
                <td><strong>{{ team.points }}</strong></td>
                <td>{{ (team.pointPercentage * 100).toFixed(1) }}%</td>
                <td>{{ team.goalsFor }}</td>
                <td>{{ team.goalsAgainst }}</td>
                <td [class.text-success]="team.goalDifferential > 0" [class.text-danger]="team.goalDifferential < 0">
                  {{ team.goalDifferential > 0 ? '+' : '' }}{{ team.goalDifferential }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- Playoff Legend -->
        <div class="card-footer bg-light">
          <div class="row text-center">
            <div class="col-md-2">
              <span class="badge bg-success me-2">P</span>
              <small>League Championship</small>
            </div>
            <div class="col-md-2">
              <span class="badge bg-info me-2">z</span>
              <small>Conference Championship</small>
            </div>
            <div class="col-md-2">
              <span class="badge bg-warning me-2">y</span>
              <small>Division Championship</small>
            </div>
            <div class="col-md-2">
              <span class="badge bg-primary me-2">x</span>
              <small>Playoff Spot</small>
            </div>
            <div class="col-md-2">
              <span class="badge bg-danger me-2">e</span>
              <small>Eliminated</small>
            </div>
            <div class="col-md-2">
              <small class="text-muted">No indicator - Still competing</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Cache info -->
    <div class="mt-4 text-center">
      <small class="text-muted">
        <i class="fas fa-clock me-1"></i>
        Data cached for faster loading â€¢ 
        <button class="btn btn-link btn-sm p-0" (click)="clearCache()">Clear cache</button>
      </small>
    </div>
  </div>

  <!-- Player Stats View -->
  <div *ngIf="currentView === 'playerstats'">
    <!-- Category Selection -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-users me-2"></i>Player Statistics Leaders
        </h5>
      </div>
      <div class="card-body">
        <div class="row align-items-center mb-3">
          <div class="col-md-8">
            <label class="form-label">Select Category</label>
            <select class="form-select" 
                    [(ngModel)]="playerStatsView" 
                    (change)="onPlayerStatsViewChange()">
              <option *ngFor="let category of playerStatsCategories" [value]="category.key">
                {{ category.label }}
              </option>
            </select>
          </div>
          <div class="col-md-4">
            <div class="form-check form-switch mt-4">
              <input class="form-check-input" 
                     type="checkbox" 
                     id="rookieFilter"
                     [(ngModel)]="showRookieOnly"
                     (change)="onRookieFilterChange()">
              <label class="form-check-label" for="rookieFilter">
                <i class="fas fa-graduation-cap me-1"></i>Rookies Only
              </label>
            </div>
          </div>
        </div>
        
        <!-- Loading Indicator -->
        <div *ngIf="loadingPlayerStats" class="text-center py-4">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading player stats...</span>
          </div>
        </div>
        
        <!-- Player Stats Table -->
        <div *ngIf="!loadingPlayerStats" class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Player</th>
                <th>Team</th>
                <th>Position</th>
                <th>GP</th>
                <th>{{ getCurrentCategoryLabel() }}</th>
                <th *ngIf="playerStatsView === 'goals' || playerStatsView === 'assists' || playerStatsView === 'points'">G</th>
                <th *ngIf="playerStatsView === 'goals' || playerStatsView === 'assists' || playerStatsView === 'points'">A</th>
                <th *ngIf="playerStatsView === 'goals' || playerStatsView === 'assists' || playerStatsView === 'points'">PTS</th>
                <th *ngIf="playerStatsView === 'saves' || playerStatsView === 'savepct' || playerStatsView === 'shutouts' || playerStatsView === 'gaa'">Saves</th>
                <th *ngIf="playerStatsView === 'saves' || playerStatsView === 'savepct' || playerStatsView === 'shutouts' || playerStatsView === 'gaa'">SA</th>
                <th *ngIf="showRookieOnly">Age</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let player of getPaginatedPlayerStats(); let i = index">
                <td>
                  <span class="rank-badge">{{ (playerStatsPage * playersPerPage) + i + 1 }}</span>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="player-info">
                      <div class="player-name">{{ player.name }}</div>
                      <small class="text-muted" *ngIf="player.rookie">
                        <i class="fas fa-star text-warning me-1"></i>Rookie
                      </small>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <img *ngIf="player.teamLogo" 
                         [src]="player.teamLogo" 
                         [alt]="player.teamName"
                         class="team-logo-small me-2">
                    <span class="team-name-small">{{ player.teamName }}</span>
                  </div>
                </td>
                <td>
                  <span class="badge position-badge" 
                        [style.background-color]="getPositionColor(player.position)">
                    {{ player.position }}
                  </span>
                </td>
                <td>{{ player.games }}</td>
                <td class="stat-highlight">
                  <strong>{{ getStatValue(player, playerStatsView) }}</strong>
                </td>
                <td *ngIf="playerStatsView === 'goals' || playerStatsView === 'assists' || playerStatsView === 'points'">
                  {{ player.goals }}
                </td>
                <td *ngIf="playerStatsView === 'goals' || playerStatsView === 'assists' || playerStatsView === 'points'">
                  {{ player.assists }}
                </td>
                <td *ngIf="playerStatsView === 'goals' || playerStatsView === 'assists' || playerStatsView === 'points'">
                  {{ player.points }}
                </td>
                <td *ngIf="playerStatsView === 'saves' || playerStatsView === 'savepct' || playerStatsView === 'shutouts' || playerStatsView === 'gaa'">
                  {{ player.saves }}
                </td>
                <td *ngIf="playerStatsView === 'saves' || playerStatsView === 'savepct' || playerStatsView === 'shutouts' || playerStatsView === 'gaa'">
                  {{ player.shotsAgainst }}
                </td>
                <td *ngIf="showRookieOnly">{{ player.age }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- Pagination -->
        <div *ngIf="!loadingPlayerStats && getFilteredPlayerStats().length > playersPerPage" 
             class="d-flex justify-content-between align-items-center mt-3">
          <div>
            <small class="text-muted">
              Showing {{ (playerStatsPage * playersPerPage) + 1 }} - 
              {{ Math.min((playerStatsPage + 1) * playersPerPage, getFilteredPlayerStats().length) }} 
              of {{ getFilteredPlayerStats().length }} players
            </small>
          </div>
          <div class="btn-group">
            <button class="btn btn-outline-secondary btn-sm" 
                    (click)="previousPlayerStatsPage()"
                    [disabled]="playerStatsPage === 0">
              <i class="fas fa-chevron-left"></i> Previous
            </button>
            <span class="btn btn-outline-secondary btn-sm disabled">
              Page {{ playerStatsPage + 1 }} of {{ getTotalPlayerStatsPages() }}
            </span>
            <button class="btn btn-outline-secondary btn-sm" 
                    (click)="nextPlayerStatsPage()"
                    [disabled]="playerStatsPage >= getTotalPlayerStatsPages() - 1">
              Next <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
        
        <!-- No Data Message -->
        <div *ngIf="!loadingPlayerStats && getFilteredPlayerStats().length === 0" 
             class="text-center py-4 text-muted">
          <i class="fas fa-chart-line fa-3x mb-3"></i>
          <h5>No Player Stats Available</h5>
          <p>{{ showRookieOnly ? 'No rookie players found with stats' : 'No players found with stats for this category' }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Team Analytics View -->
  <div *ngIf="currentView === 'analytics'">
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Team Analytics</h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label for="teamSelect" class="form-label">Select Team</label>
          <select id="teamSelect" class="form-select" [(ngModel)]="selectedTeamId" (change)="onTeamSelect()">
            <option value="">-- Choose a Team --</option>
            <option *ngFor="let team of teams" [value]="team.id">{{ team.name }}</option>
          </select>
        </div>

        <div *ngIf="selectedTeamId" class="row">
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body">
                <i class="fas fa-gamepad fa-2x text-primary mb-2"></i>
                <h5 class="card-title">Total Games</h5>
                <h2 class="text-primary">{{ totalGames }}</h2>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body">
                <i class="fas fa-bullseye fa-2x text-success mb-2"></i>
                <h5 class="card-title">Total Points</h5>
                <h2 class="text-success">{{ totalPoints }}</h2>
                <small class="text-muted">Avg: {{ avgPoints }}</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body">
                <i class="fas fa-hands-helping fa-2x text-info mb-2"></i>
                <h5 class="card-title">Total Assists</h5>
                <h2 class="text-info">{{ totalAssists }}</h2>
                <small class="text-muted">Avg: {{ avgAssists }}</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body">
                <i class="fas fa-undo fa-2x text-warning mb-2"></i>
                <h5 class="card-title">Total Rebounds</h5>
                <h2 class="text-warning">{{ totalRebounds }}</h2>
                <small class="text-muted">Avg: {{ avgRebounds }}</small>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="selectedTeamId" class="mt-4">
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">{{ selectedTeamName }} Team Statistics</h6>
            </div>
            <div class="card-body">
              <div class="row text-center">
                <div class="col-md-4">
                  <div class="border rounded p-3">
                    <h6 class="text-muted">Games Played</h6>
                    <h4 class="text-primary">{{ totalGames }}</h4>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="border rounded p-3">
                    <h6 class="text-muted">Average Points per Game</h6>
                    <h4 class="text-success">{{ avgPoints }}</h4>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="border rounded p-3">
                    <h6 class="text-muted">Average Assists per Game</h6>
                    <h4 class="text-info">{{ avgAssists }}</h4>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Export Reports View -->
  <div *ngIf="currentView === 'reports'">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Export Game Data</h5>
      </div>
      <div class="card-body">
        <!-- Team Selection -->
        <div class="mb-3">
          <label for="exportTeamSelect" class="form-label">Select Team</label>
          <select id="exportTeamSelect" class="form-select" [(ngModel)]="selectedExportTeamId" (change)="onExportTeamSelect()">
            <option value="">-- Choose a Team --</option>
            <option *ngFor="let team of teams" [value]="team.id">{{ team.name }}</option>
          </select>
        </div>

        <!-- Game Selection -->
        <div class="mb-3" *ngIf="selectedExportTeamId">
          <label for="exportGameSelect" class="form-label">Select Game</label>
          <select id="exportGameSelect" class="form-select" [(ngModel)]="selectedExportGameId">
            <option value="">-- Choose a Game --</option>
            <option *ngFor="let game of exportGames" [value]="game.id">
              {{ game['date']?.toDate?.() ? (game['date'].toDate() | date:'mediumDate') : game['date'] }} vs {{ game['opponent'] }}
            </option>
          </select>
        </div>

        <!-- Export Button -->
        <div class="text-center mt-4">
          <button class="btn btn-success" 
                  (click)="exportSelectedGameToCSV()" 
                  [disabled]="!selectedExportTeamId || !selectedExportGameId">
            <i class="fas fa-download me-2"></i>Export Selected Game to CSV
          </button>
        </div>
      </div>
    </div>
  </div>
</div>