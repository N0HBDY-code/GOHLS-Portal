<div class="container mt-4">
  <!-- Page Title -->
  <h2 class="page-title">
    <i class="fas fa-chart-line me-2"></i>Stats and Standings
  </h2>

  <!-- Navigation Tabs -->
  <div class="mb-4">
    <ul class="nav nav-tabs">
      <li class="nav-item">
        <a class="nav-link" 
           [class.active]="currentView === 'standings'"
           (click)="currentView = 'standings'">
          <i class="fas fa-trophy me-1"></i> Standings
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" 
           [class.active]="currentView === 'playerstats'"
           (click)="onPlayerStatsTabClick()">
          <i class="fas fa-users me-1"></i> Player Stats
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" 
           [class.active]="currentView === 'analytics'"
           (click)="currentView = 'analytics'">
          <i class="fas fa-chart-line me-1"></i> Team Analytics
        </a>
      </li>
    </ul>
  </div>

  <!-- Standings View -->
  <div *ngIf="currentView === 'standings'">
    <!-- League and View Selection -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
          <h5 class="mb-0">League Standings</h5>
          
          <div class="d-flex gap-3 align-items-center flex-wrap">
            <!-- View Type Selection -->
            <div class="btn-group">
              <button class="btn btn-sm" 
                      [class.btn-info]="standingsViewType === 'division'"
                      [class.btn-outline-info]="standingsViewType !== 'division'"
                      (click)="standingsViewType = 'division'; onStandingsViewChange()">
                <i class="fas fa-layer-group me-1"></i>By Division
              </button>
              <button class="btn btn-sm"
                      [class.btn-info]="standingsViewType === 'conference'"
                      [class.btn-outline-info]="standingsViewType !== 'conference'"
                      (click)="standingsViewType = 'conference'; onStandingsViewChange()">
                <i class="fas fa-sitemap me-1"></i>By Conference
              </button>
              <button class="btn btn-sm"
                      [class.btn-info]="standingsViewType === 'overall'"
                      [class.btn-outline-info]="standingsViewType !== 'overall'"
                      (click)="standingsViewType = 'overall'; onStandingsViewChange()">
                <i class="fas fa-globe me-1"></i>Overall
              </button>
            </div>

            <!-- League Selection -->
            <div class="btn-group">
              <button class="btn" 
                      [class.btn-primary]="selectedLeague === 'major'"
                      [class.btn-outline-primary]="selectedLeague !== 'major'"
                      (click)="selectedLeague = 'major'; onLeagueChange()">
                Major League
              </button>
              <button class="btn"
                      [class.btn-primary]="selectedLeague === 'minor'"
                      [class.btn-outline-primary]="selectedLeague !== 'minor'"
                      (click)="selectedLeague = 'minor'; onLeagueChange()">
                Minor League
              </button>
            </div>

            <!-- Management Buttons -->
            <div class="btn-group">
              <button *ngIf="canManagePlayoffs"
                      class="btn btn-outline-warning btn-sm" 
                      (click)="showPlayoffManager = !showPlayoffManager"
                      title="Manage playoff clinching status">
                <i class="fas fa-cog me-1"></i>Manage Playoffs
              </button>
              
              <!-- Refresh Button -->
              <button class="btn btn-outline-secondary btn-sm" 
                      (click)="refreshStandings()"
                      [disabled]="loadingStandings"
                      title="Refresh standings data">
                <i class="fas fa-sync-alt" [class.fa-spin]="loadingStandings"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Playoff Management Panel -->
    <div *ngIf="showPlayoffManager && canManagePlayoffs" class="card mb-4 border-warning">
      <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">
          <i class="fas fa-trophy me-2"></i>Playoff Status Management
        </h5>
      </div>
      <div class="card-body">
        <p class="mb-3">Set playoff clinching status for teams. This will add visual indicators to the standings.</p>
        
        <div class="row">
          <div *ngFor="let team of filteredTeams" class="col-md-4 mb-3">
            <div class="card">
              <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                  <img *ngIf="team.logoUrl" 
                       [src]="team.logoUrl" 
                       [alt]="team.name"
                       class="team-logo-small me-2">
                  <strong>{{ team.name }}</strong>
                </div>
                <select class="form-select form-select-sm" 
                        [value]="getTeamPlayoffStatus(team.id)"
                        (change)="updateTeamPlayoffStatus(team.id, $any($event.target).value)">
                  <option value="none">No Status</option>
                  <option value="league">League Championship Clinched (P)</option>
                  <option value="conference">Conference Championship Clinched (z)</option>
                  <option value="division">Division Championship Clinched (y)</option>
                  <option value="playoff">Playoff Spot Clinched (x)</option>
                  <option value="eliminated">Eliminated (e)</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Indicator -->
    <div *ngIf="loadingStandings" class="text-center py-4">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading standings...</span>
      </div>
    </div>

    <!-- Division View -->
    <div *ngIf="standingsViewType === 'division' && !loadingStandings">
      <div *ngFor="let conference of conferences" class="mb-4">
        <h3>{{ conference.name }}</h3>
        <div class="row">
          <div *ngFor="let division of conference.divisions" class="col-lg-4 mb-3">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">{{ division }}</h5>
              </div>
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead>
                    <tr>
                      <th>Team</th>
                      <th>GP</th>
                      <th>W</th>
                      <th>L</th>
                      <th>OTL</th>
                      <th>PTS</th>
                      <th>GF</th>
                      <th>GA</th>
                      <th>DIFF</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let team of getStandingsForDivision(conference.name, division)" 
                        [class]="getPlayoffStatusClass(team)">
                      <td>
                        <div class="d-flex align-items-center">
                          <img *ngIf="team.logoUrl" [src]="team.logoUrl" class="team-logo-small me-2" alt="{{ team.name }}">
                          <span>{{ team.name }}</span>
                          <span *ngIf="getPlayoffStatusBadge(team) as badge" [class]="badge.class" class="ms-1">
                            {{ badge.text }}
                          </span>
                        </div>
                      </td>
                      <td>{{ team.gamesPlayed }}</td>
                      <td>{{ team.wins }}</td>
                      <td>{{ team.losses }}</td>
                      <td>{{ team.overtimeLosses }}</td>
                      <td><strong>{{ team.points }}</strong></td>
                      <td>{{ team.goalsFor }}</td>
                      <td>{{ team.goalsAgainst }}</td>
                      <td [class.text-success]="team.goalDifferential > 0" [class.text-danger]="team.goalDifferential < 0">
                        {{ team.goalDifferential > 0 ? '+' : '' }}{{ team.goalDifferential }}
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Conference View -->
    <div *ngIf="standingsViewType === 'conference' && !loadingStandings">
      <div *ngFor="let conference of conferences" class="mb-4">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h4 class="mb-0">{{ conference.name }}</h4>
          </div>
          <div class="table-responsive">
            <table class="table table-striped mb-0">
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Team</th>
                  <th>GP</th>
                  <th>W</th>
                  <th>L</th>
                  <th>OTL</th>
                  <th>PTS</th>
                  <th>P%</th>
                  <th>GF</th>
                  <th>GA</th>
                  <th>DIFF</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let team of getStandingsForConference(conference.name); let i = index" 
                    [class]="getPlayoffStatusClass(team)">
                  <td>{{ i + 1 }}</td>
                  <td>
                    <div class="d-flex align-items-center">
                      <img *ngIf="team.logoUrl" [src]="team.logoUrl" class="team-logo-small me-2" alt="{{ team.name }}">
                      <span>{{ team.name }}</span>
                      <span *ngIf="getPlayoffStatusBadge(team) as badge" [class]="badge.class" class="ms-1">
                        {{ badge.text }}
                      </span>
                    </div>
                  </td>
                  <td>{{ team.gamesPlayed }}</td>
                  <td>{{ team.wins }}</td>
                  <td>{{ team.losses }}</td>
                  <td>{{ team.overtimeLosses }}</td>
                  <td><strong>{{ team.points }}</strong></td>
                  <td>{{ (team.pointPercentage * 100).toFixed(1) }}%</td>
                  <td>{{ team.goalsFor }}</td>
                  <td>{{ team.goalsAgainst }}</td>
                  <td [class.text-success]="team.goalDifferential > 0" [class.text-danger]="team.goalDifferential < 0">
                    {{ team.goalDifferential > 0 ? '+' : '' }}{{ team.goalDifferential }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Overall View -->
    <div *ngIf="standingsViewType === 'overall' && !loadingStandings">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h4 class="mb-0">{{ selectedLeague | titlecase }} League Overall Standings</h4>
        </div>
        <div class="table-responsive">
          <table class="table table-striped mb-0">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Team</th>
                <th>Conference</th>
                <th>Division</th>
                <th>GP</th>
                <th>W</th>
                <th>L</th>
                <th>OTL</th>
                <th>PTS</th>
                <th>P%</th>
                <th>GF</th>
                <th>GA</th>
                <th>DIFF</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let team of getOverallStandings(); let i = index" 
                  [class]="getPlayoffStatusClass(team)">
                <td>{{ i + 1 }}</td>
                <td>
                  <div class="d-flex align-items-center">
                    <img *ngIf="team.logoUrl" [src]="team.logoUrl" class="team-logo-small me-2" alt="{{ team.name }}">
                    <span>{{ team.name }}</span>
                    <span *ngIf="getPlayoffStatusBadge(team) as badge" [class]="badge.class" class="ms-1">
                      {{ badge.text }}
                    </span>
                  </div>
                </td>
                <td><small class="text-muted">{{ team.conference }}</small></td>
                <td><small class="text-muted">{{ team.division }}</small></td>
                <td>{{ team.gamesPlayed }}</td>
                <td>{{ team.wins }}</td>
                <td>{{ team.losses }}</td>
                <td>{{ team.overtimeLosses }}</td>
                <td><strong>{{ team.points }}</strong></td>
                <td>{{ (team.pointPercentage * 100).toFixed(1) }}%</td>
                <td>{{ team.goalsFor }}</td>
                <td>{{ team.goalsAgainst }}</td>
                <td [class.text-success]="team.goalDifferential > 0" [class.text-danger]="team.goalDifferential < 0">
                  {{ team.goalDifferential > 0 ? '+' : '' }}{{ team.goalDifferential }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- Playoff Legend -->
        <div class="card-footer bg-light">
          <div class="row text-center">
            <div class="col-md-2">
              <span class="badge bg-success me-2">P</span>
              <small>League Championship</small>
            </div>
            <div class="col-md-2">
              <span class="badge bg-info me-2">z</span>
              <small>Conference Championship</small>
            </div>
            <div class="col-md-2">
              <span class="badge bg-warning me-2">y</span>
              <small>Division Championship</small>
            </div>
            <div class="col-md-2">
              <span class="badge bg-primary me-2">x</span>
              <small>Playoff Spot</small>
            </div>
            <div class="col-md-2">
              <span class="badge bg-danger me-2">e</span>
              <small>Eliminated</small>
            </div>
            <div class="col-md-2">
              <small class="text-muted">No indicator - Still competing</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Cache info -->
    <div class="mt-4 text-center">
      <small class="text-muted">
        <i class="fas fa-clock me-1"></i>
        Data cached for faster loading • 
        <button class="btn btn-link btn-sm p-0" (click)="clearCache()">Clear cache</button>
      </small>
    </div>
  </div>

  <!-- Player Stats View -->
  <div *ngIf="currentView === 'playerstats'">
    <!-- Category Selection -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-users me-2"></i>Player Statistics Leaders
        </h5>
      </div>
      <div class="card-body">
        <div class="row align-items-center mb-3">
          <div class="col-md-8">
            <label class="form-label">Select Category</label>
            <select class="form-select" 
                    [(ngModel)]="playerStatsView" 
                    (change)="onPlayerStatsViewChange()">
              <option *ngFor="let category of playerStatsCategories" [value]="category.key">
                {{ category.label }}
              </option>
            </select>
          </div>
          <div class="col-md-4">
            <div class="form-check form-switch mt-4">
              <input class="form-check-input" 
                     type="checkbox" 
                     id="rookieFilter"
                     [(ngModel)]="showRookieOnly"
                     (change)="onRookieFilterChange()">
              <label class="form-check-label" for="rookieFilter">
                <i class="fas fa-graduation-cap me-1"></i>Rookies Only
              </label>
            </div>
          </div>
        </div>
        
        <!-- Loading Indicator -->
        <div *ngIf="loadingPlayerStats" class="text-center py-4">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading player stats...</span>
          </div>
        </div>
        
        <!-- Player Stats Table -->
        <div *ngIf="!loadingPlayerStats" class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Player</th>
                <th>Team</th>
                <th>Position</th>
                <th>GP</th>
                <th>{{ getCurrentCategoryLabel() }}</th>
                <th *ngIf="playerStatsView === 'goals' || playerStatsView === 'assists' || playerStatsView === 'points'">G</th>
                <th *ngIf="playerStatsView === 'goals' || playerStatsView === 'assists' || playerStatsView === 'points'">A</th>
                <th *ngIf="playerStatsView === 'goals' || playerStatsView === 'assists' || playerStatsView === 'points'">PTS</th>
                <th *ngIf="playerStatsView === 'saves' || playerStatsView === 'savepct' || playerStatsView === 'shutouts' || playerStatsView === 'gaa'">Saves</th>
                <th *ngIf="playerStatsView === 'saves' || playerStatsView === 'savepct' || playerStatsView === 'shutouts' || playerStatsView === 'gaa'">SA</th>
                <th *ngIf="showRookieOnly">Age</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let player of getPaginatedPlayerStats(); let i = index">
                <td>
                  <span class="rank-badge">{{ (playerStatsPage * playersPerPage) + i + 1 }}</span>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="player-info">
                      <div class="player-name">{{ player.name }}</div>
                      <small class="text-muted" *ngIf="player.rookie">
                        <i class="fas fa-star text-warning me-1"></i>Rookie
                      </small>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <img *ngIf="player.teamLogo" 
                         [src]="player.teamLogo" 
                         [alt]="player.teamName"
                         class="team-logo-small me-2">
                    <span class="team-name-small">{{ player.teamName }}</span>
                  </div>
                </td>
                <td>
                  <span class="badge position-badge" 
                        [style.background-color]="getPositionColor(player.position)">
                    {{ player.position }}
                  </span>
                </td>
                <td>{{ player.games }}</td>
                <td class="stat-highlight">
                  <strong>{{ getStatValue(player, playerStatsView) }}</strong>
                </td>
                <td *ngIf="playerStatsView === 'goals' || playerStatsView === 'assists' || playerStatsView === 'points'">
                  {{ player.goals }}
                </td>
                <td *ngIf="playerStatsView === 'goals' || playerStatsView === 'assists' || playerStatsView === 'points'">
                  {{ player.assists }}
                </td>
                <td *ngIf="playerStatsView === 'goals' || playerStatsView === 'assists' || playerStatsView === 'points'">
                  {{ player.points }}
                </td>
                <td *ngIf="playerStatsView === 'saves' || playerStatsView === 'savepct' || playerStatsView === 'shutouts' || playerStatsView === 'gaa'">
                  {{ player.saves }}
                </td>
                <td *ngIf="playerStatsView === 'saves' || playerStatsView === 'savepct' || playerStatsView === 'shutouts' || playerStatsView === 'gaa'">
                  {{ player.shotsAgainst }}
                </td>
                <td *ngIf="showRookieOnly">{{ player.age }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- Pagination -->
        <div *ngIf="!loadingPlayerStats && getFilteredPlayerStats().length > playersPerPage" 
             class="d-flex justify-content-between align-items-center mt-3">
          <div>
            <small class="text-muted">
              Showing {{ (playerStatsPage * playersPerPage) + 1 }} - 
              {{ Math.min((playerStatsPage + 1) * playersPerPage, getFilteredPlayerStats().length) }} 
              of {{ getFilteredPlayerStats().length }} players
            </small>
          </div>
          <div class="btn-group">
            <button class="btn btn-outline-secondary btn-sm" 
                    (click)="previousPlayerStatsPage()"
                    [disabled]="playerStatsPage === 0">
              <i class="fas fa-chevron-left"></i> Previous
            </button>
            <span class="btn btn-outline-secondary btn-sm disabled">
              Page {{ playerStatsPage + 1 }} of {{ getTotalPlayerStatsPages() }}
            </span>
            <button class="btn btn-outline-secondary btn-sm" 
                    (click)="nextPlayerStatsPage()"
                    [disabled]="playerStatsPage >= getTotalPlayerStatsPages() - 1">
              Next <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
        
        <!-- No Data Message -->
        <div *ngIf="!loadingPlayerStats && getFilteredPlayerStats().length === 0" 
             class="text-center py-4 text-muted">
          <i class="fas fa-chart-line fa-3x mb-3"></i>
          <h5>No Player Stats Available</h5>
          <p>{{ showRookieOnly ? 'No rookie players found with stats' : 'No players found with stats for this category' }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Team Analytics View -->
  <div *ngIf="currentView === 'analytics'">
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-chart-bar me-2"></i>Team Analytics
        </h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label for="teamSelect" class="form-label">Select Team</label>
          <select id="teamSelect" class="form-select" [(ngModel)]="selectedTeamId" (change)="onTeamSelect()">
            <option value="">-- Choose a Team --</option>
            <option *ngFor="let team of teams" [value]="team.id">{{ team.name }}</option>
          </select>
        </div>

        <!-- Debug Information -->
        <div class="alert alert-info mb-3" *ngIf="selectedTeamId">
          <h6>Debug Info:</h6>
          <p>Selected Team ID: {{ selectedTeamId }}</p>
          <p>Selected Team Name: {{ selectedTeamName }}</p>
          <p>Total Games: {{ teamAnalytics.totalGames }}</p>
          <p>Team Roster Length: {{ teamRoster.length || 0 }}</p>
        </div>

        <!-- Team Analytics Display -->
        <div *ngIf="selectedTeamId && selectedTeamName">
          <!-- Team Header with Logo -->
          <div class="team-analytics-header">
            <div class="d-flex align-items-center justify-content-center mb-4">
              <div class="team-logo-container me-4">
                <img *ngIf="getSelectedTeamLogo()" 
                     [src]="getSelectedTeamLogo()" 
                     [alt]="selectedTeamName"
                     class="team-logo-large">
                <div *ngIf="!getSelectedTeamLogo()" class="team-logo-placeholder">
                  <i class="fas fa-hockey-puck fa-3x"></i>
                </div>
              </div>
              <div class="team-header-info">
                <h2 class="team-name-large">{{ selectedTeamName }}</h2>
                <p class="team-subtitle">Season Analytics Dashboard</p>
                <div class="quick-stats">
                  <span class="quick-stat-item">
                    <i class="fas fa-calendar me-1"></i>{{ teamAnalytics.totalGames }} Games
                  </span>
                  <span class="quick-stat-item">
                    <i class="fas fa-chart-line me-1"></i>
                    {{ formatRecord({ 
                      wins: teamAnalytics.homeRecord.wins + teamAnalytics.awayRecord.wins,
                      losses: teamAnalytics.homeRecord.losses + teamAnalytics.awayRecord.losses,
                      otl: teamAnalytics.homeRecord.otl + teamAnalytics.awayRecord.otl
                    }) }}
                  </span>
                  <span class="quick-stat-item">
                    <i class="fas fa-bullseye me-1"></i>{{ teamAnalytics.goalDifferential > 0 ? '+' : '' }}{{ teamAnalytics.goalDifferential }}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- No Games Warning -->
          <div *ngIf="teamAnalytics.totalGames === 0" class="alert alert-warning text-center">
            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
            <h5>No Game Data Available</h5>
            <p class="mb-0">This team hasn't played any completed games with recorded scores yet.</p>
          </div>

          <!-- Comprehensive Analytics Display -->
          <div *ngIf="teamAnalytics.totalGames > 0">
            <!-- Key Performance Indicators -->
            <div class="kpi-section mb-5">
              <h4 class="section-title">
                <i class="fas fa-tachometer-alt me-2"></i>Key Performance Indicators
              </h4>
              <div class="row">
                <div class="col-lg-3 col-md-6 mb-3">
                  <div class="kpi-card offensive">
                    <div class="kpi-icon">
                      <i class="fas fa-bullseye"></i>
                    </div>
                    <div class="kpi-content">
                      <div class="kpi-value">{{ formatDecimal(teamAnalytics.avgGoalsPerGame, 2) }}</div>
                      <div class="kpi-label">Goals Per Game</div>
                      <div class="kpi-detail">{{ teamAnalytics.goals }} total goals</div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                  <div class="kpi-card defensive">
                    <div class="kpi-icon">
                      <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="kpi-content">
                      <div class="kpi-value">{{ formatDecimal(teamAnalytics.avgGoalsAgainstPerGame, 2) }}</div>
                      <div class="kpi-label">Goals Against Per Game</div>
                      <div class="kpi-detail">{{ teamAnalytics.goalsAgainst }} total against</div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                  <div class="kpi-card shooting">
                    <div class="kpi-icon">
                      <i class="fas fa-percentage"></i>
                    </div>
                    <div class="kpi-content">
                      <div class="kpi-value">{{ formatPercentage(teamAnalytics.shootingPercentage) }}</div>
                      <div class="kpi-label">Shooting Percentage</div>
                      <div class="kpi-detail">{{ teamAnalytics.shotAttempts }} shot attempts</div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                  <div class="kpi-card faceoff">
                    <div class="kpi-icon">
                      <i class="fas fa-dot-circle"></i>
                    </div>
                    <div class="kpi-content">
                      <div class="kpi-value">{{ formatPercentage(teamAnalytics.faceoffPercentage) }}</div>
                      <div class="kpi-label">Faceoff Percentage</div>
                      <div class="kpi-detail">{{ teamAnalytics.faceoffsWon }}/{{ teamAnalytics.faceoffsTaken }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Record Analysis -->
            <div class="analytics-section mb-5">
              <h4 class="section-title">
                <i class="fas fa-chart-bar me-2"></i>Record Analysis
              </h4>
              <div class="row">
                <div class="col-lg-4 mb-4">
                  <div class="analytics-card record-card">
                    <div class="card-icon">
                      <i class="fas fa-home"></i>
                    </div>
                    <h5>Home Performance</h5>
                    <div class="record-display">{{ formatRecord(teamAnalytics.homeRecord) }}</div>
                    <div class="record-breakdown">
                      <span class="win-stat">{{ teamAnalytics.homeRecord.wins }}W</span>
                      <span class="loss-stat">{{ teamAnalytics.homeRecord.losses }}L</span>
                      <span class="otl-stat">{{ teamAnalytics.homeRecord.otl }}OTL</span>
                    </div>
                  </div>
                </div>
                <div class="col-lg-4 mb-4">
                  <div class="analytics-card record-card">
                    <div class="card-icon">
                      <i class="fas fa-plane"></i>
                    </div>
                    <h5>Away Performance</h5>
                    <div class="record-display">{{ formatRecord(teamAnalytics.awayRecord) }}</div>
                    <div class="record-breakdown">
                      <span class="win-stat">{{ teamAnalytics.awayRecord.wins }}W</span>
                      <span class="loss-stat">{{ teamAnalytics.awayRecord.losses }}L</span>
                      <span class="otl-stat">{{ teamAnalytics.awayRecord.otl }}OTL</span>
                    </div>
                  </div>
                </div>
                <div class="col-lg-4 mb-4">
                  <div class="analytics-card streak-card">
                    <div class="card-icon">
                      <i class="fas fa-fire"></i>
                    </div>
                    <h5>Current Streak</h5>
                    <div class="streak-display" 
                         [class.win-streak]="teamAnalytics.currentStreak.type === 'W'"
                         [class.lose-streak]="teamAnalytics.currentStreak.type === 'L'">
                      {{ formatStreak(teamAnalytics.currentStreak) }}
                    </div>
                    <div class="streak-history">
                      <small>Longest Win: {{ teamAnalytics.longestWinStreak }}</small>
                      <small>Longest Loss: {{ teamAnalytics.longestLoseStreak }}</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Offensive Analytics -->
            <div class="analytics-section mb-5">
              <h4 class="section-title">
                <i class="fas fa-bullseye me-2"></i>Offensive Analytics
              </h4>
              <div class="row">
                <div class="col-lg-8">
                  <div class="analytics-grid">
                    <div class="analytics-stat-card goals">
                      <div class="stat-icon"><i class="fas fa-bullseye"></i></div>
                      <div class="stat-content">
                        <div class="stat-number">{{ teamAnalytics.goals }}</div>
                        <div class="stat-label">Total Goals</div>
                        <div class="stat-detail">{{ formatDecimal(teamAnalytics.avgGoalsPerGame, 2) }} per game</div>
                      </div>
                    </div>
                    <div class="analytics-stat-card even-strength">
                      <div class="stat-icon"><i class="fas fa-equals"></i></div>
                      <div class="stat-content">
                        <div class="stat-number">{{ teamAnalytics.evenStrengthGoals }}</div>
                        <div class="stat-label">Even Strength</div>
                        <div class="stat-detail">{{ ((teamAnalytics.evenStrengthGoals / teamAnalytics.goals) * 100).toFixed(1) }}% of goals</div>
                      </div>
                    </div>
                    <div class="analytics-stat-card shots">
                      <div class="stat-icon"><i class="fas fa-hockey-puck"></i></div>
                      <div class="stat-content">
                        <div class="stat-number">{{ teamAnalytics.shotAttempts }}</div>
                        <div class="stat-label">Shot Attempts</div>
                        <div class="stat-detail">{{ formatPercentage(teamAnalytics.shootingPercentage) }} accuracy</div>
                      </div>
                    </div>
                    <div class="analytics-stat-card attack-time">
                      <div class="stat-icon"><i class="fas fa-clock"></i></div>
                      <div class="stat-content">
                        <div class="stat-number">{{ formatTime(teamAnalytics.timeOnAttack) }}</div>
                        <div class="stat-label">Time on Attack</div>
                        <div class="stat-detail">{{ formatTime(teamAnalytics.timeOnAttackPerGoal) }} per goal</div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-4">
                  <div class="highlight-card offensive-highlight">
                    <h6><i class="fas fa-trophy me-2"></i>Offensive Highlights</h6>
                    <div class="highlight-item">
                      <span class="highlight-label">Most Goals in Game:</span>
                      <span class="highlight-value">{{ teamAnalytics.mostGoalsInGame }}</span>
                    </div>
                    <div class="highlight-item">
                      <span class="highlight-label">Goals Per Game:</span>
                      <span class="highlight-value">{{ formatDecimal(teamAnalytics.avgGoalsPerGame, 2) }}</span>
                    </div>
                    <div class="highlight-item">
                      <span class="highlight-label">Shooting Accuracy:</span>
                      <span class="highlight-value">{{ formatPercentage(teamAnalytics.shootingPercentage) }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Defensive Analytics -->
            <div class="analytics-section mb-5">
              <h4 class="section-title">
                <i class="fas fa-shield-alt me-2"></i>Defensive Analytics
              </h4>
              <div class="row">
                <div class="col-lg-8">
                  <div class="analytics-grid">
                    <div class="analytics-stat-card goals-against">
                      <div class="stat-icon"><i class="fas fa-shield-alt"></i></div>
                      <div class="stat-content">
                        <div class="stat-number">{{ teamAnalytics.goalsAgainst }}</div>
                        <div class="stat-label">Goals Against</div>
                        <div class="stat-detail">{{ formatDecimal(teamAnalytics.avgGoalsAgainstPerGame, 2) }} per game</div>
                      </div>
                    </div>
                    <div class="analytics-stat-card shots-against">
                      <div class="stat-icon"><i class="fas fa-crosshairs"></i></div>
                      <div class="stat-content">
                        <div class="stat-number">{{ teamAnalytics.shotsAgainst }}</div>
                        <div class="stat-label">Shots Against</div>
                        <div class="stat-detail">{{ formatPercentage(teamAnalytics.goalsAgainstPercentage) }} GA%</div>
                      </div>
                    </div>
                    <div class="analytics-stat-card goal-diff">
                      <div class="stat-icon">
                        <i class="fas" [class.fa-arrow-up]="teamAnalytics.goalDifferential > 0" 
                           [class.fa-arrow-down]="teamAnalytics.goalDifferential < 0"
                           [class.fa-minus]="teamAnalytics.goalDifferential === 0"></i>
                      </div>
                      <div class="stat-content">
                        <div class="stat-number" 
                             [class.positive]="teamAnalytics.goalDifferential > 0"
                             [class.negative]="teamAnalytics.goalDifferential < 0">
                          {{ teamAnalytics.goalDifferential > 0 ? '+' : '' }}{{ teamAnalytics.goalDifferential }}
                        </div>
                        <div class="stat-label">Goal Differential</div>
                        <div class="stat-detail">{{ teamAnalytics.goals }} GF - {{ teamAnalytics.goalsAgainst }} GA</div>
                      </div>
                    </div>
                    <div class="analytics-stat-card defense-time">
                      <div class="stat-icon"><i class="fas fa-stopwatch"></i></div>
                      <div class="stat-content">
                        <div class="stat-number">{{ formatTime(teamAnalytics.timeOnDefense) }}</div>
                        <div class="stat-label">Time on Defense</div>
                        <div class="stat-detail">{{ formatTime(teamAnalytics.timeOnDefensePerGoal) }} per GA</div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-4">
                  <div class="highlight-card defensive-highlight">
                    <h6><i class="fas fa-shield me-2"></i>Defensive Highlights</h6>
                    <div class="highlight-item">
                      <span class="highlight-label">Most Goals Against:</span>
                      <span class="highlight-value">{{ teamAnalytics.mostGoalsAgainstInGame }}</span>
                    </div>
                    <div class="highlight-item">
                      <span class="highlight-label">GA Per Game:</span>
                      <span class="highlight-value">{{ formatDecimal(teamAnalytics.avgGoalsAgainstPerGame, 2) }}</span>
                    </div>
                    <div class="highlight-item">
                      <span class="highlight-label">Save Percentage:</span>
                      <span class="highlight-value">{{ formatPercentage(100 - teamAnalytics.goalsAgainstPercentage) }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Special Teams & Discipline -->
            <div class="analytics-section mb-5">
              <h4 class="section-title">
                <i class="fas fa-bolt me-2"></i>Special Teams & Discipline
              </h4>
              <div class="row">
                <div class="col-lg-6 mb-4">
                  <div class="special-teams-card powerplay">
                    <div class="st-header">
                      <i class="fas fa-bolt me-2"></i>
                      <h5>Powerplay Performance</h5>
                    </div>
                    <div class="st-stats">
                      <div class="st-main-stat">
                        <span class="st-value">{{ formatTime(teamAnalytics.powerplayTimeOnIce) }}</span>
                        <span class="st-label">Total PP Time</span>
                      </div>
                      <div class="st-secondary-stats">
                        <div class="st-secondary-stat">
                          <span class="value">{{ teamAnalytics.powerplayTimeOnIce > 0 ? formatDecimal(teamAnalytics.powerplayTimeOnIce / teamAnalytics.totalGames, 1) : '0.0' }}</span>
                          <span class="label">Avg PP Time/Game</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-6 mb-4">
                  <div class="special-teams-card penalty-kill">
                    <div class="st-header">
                      <i class="fas fa-shield-alt me-2"></i>
                      <h5>Penalty Kill Performance</h5>
                    </div>
                    <div class="st-stats">
                      <div class="st-main-stat">
                        <span class="st-value">{{ formatPercentage(teamAnalytics.penaltyKillPercentage) }}</span>
                        <span class="st-label">PK Success Rate</span>
                      </div>
                      <div class="st-secondary-stats">
                        <div class="st-secondary-stat">
                          <span class="value">{{ formatPenaltyKills(teamAnalytics.penaltyKills.successful, teamAnalytics.penaltyKills.total) }}</span>
                          <span class="label">Successful/Total</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Game Flow Analytics -->
            <div class="analytics-section mb-5">
              <h4 class="section-title">
                <i class="fas fa-chart-line me-2"></i>Game Flow Analytics
              </h4>
              <div class="row">
                <div class="col-lg-6 mb-4">
                  <div class="flow-card possession">
                    <h5><i class="fas fa-exchange-alt me-2"></i>Puck Possession</h5>
                    <div class="flow-stats">
                      <div class="flow-stat">
                        <div class="flow-bar">
                          <div class="flow-fill attack" 
                               [style.width.%]="(teamAnalytics.timeOnAttack / (teamAnalytics.timeOnAttack + teamAnalytics.timeOnDefense)) * 100">
                          </div>
                        </div>
                        <div class="flow-labels">
                          <span class="attack-label">Attack: {{ formatTime(teamAnalytics.timeOnAttack) }}</span>
                          <span class="defense-label">Defense: {{ formatTime(teamAnalytics.timeOnDefense) }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-6 mb-4">
                  <div class="flow-card efficiency">
                    <h5><i class="fas fa-target me-2"></i>Efficiency Metrics</h5>
                    <div class="efficiency-stats">
                      <div class="efficiency-item">
                        <span class="eff-label">Attack Time per Goal:</span>
                        <span class="eff-value">{{ formatTime(teamAnalytics.timeOnAttackPerGoal) }}</span>
                      </div>
                      <div class="efficiency-item">
                        <span class="eff-label">Defense Time per GA:</span>
                        <span class="eff-value">{{ formatTime(teamAnalytics.timeOnDefensePerGoal) }}</span>
                      </div>
                      <div class="efficiency-item">
                        <span class="eff-label">Passing Accuracy:</span>
                        <span class="eff-value">{{ formatPercentage(teamAnalytics.passingPercentage) }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Physical Play & Discipline -->
            <div class="analytics-section mb-5">
              <h4 class="section-title">
                <i class="fas fa-fist-raised me-2"></i>Physical Play & Discipline
              </h4>
              <div class="row">
                <div class="col-lg-4 mb-3">
                  <div class="physical-card hits">
                    <div class="physical-icon"><i class="fas fa-fist-raised"></i></div>
                    <div class="physical-stat">
                      <div class="physical-number">{{ teamAnalytics.hits }}</div>
                      <div class="physical-label">Total Hits</div>
                      <div class="physical-avg">{{ formatDecimal(teamAnalytics.hits / teamAnalytics.totalGames, 1) }} per game</div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-4 mb-3">
                  <div class="physical-card fights">
                    <div class="physical-icon"><i class="fas fa-fire"></i></div>
                    <div class="physical-stat">
                      <div class="physical-number">{{ teamAnalytics.fights }}</div>
                      <div class="physical-label">Fights</div>
                      <div class="physical-avg">{{ formatDecimal(teamAnalytics.fights / teamAnalytics.totalGames, 1) }} per game</div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-4 mb-3">
                  <div class="physical-card faceoffs">
                    <div class="physical-icon"><i class="fas fa-dot-circle"></i></div>
                    <div class="physical-stat">
                      <div class="physical-number">{{ formatPercentage(teamAnalytics.faceoffPercentage) }}</div>
                      <div class="physical-label">Faceoff Win %</div>
                      <div class="physical-avg">{{ teamAnalytics.faceoffsWon }}/{{ teamAnalytics.faceoffsTaken }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Team Roster Section -->
          <div *ngIf="teamRoster.length > 0" class="roster-section">
            <h4 class="section-title">
              <i class="fas fa-users me-2"></i>{{ selectedTeamName }} - Player Statistics
            </h4>
            <div class="roster-card">
              <div class="table-responsive">
                <table class="table table-hover roster-table">
                  <thead>
                    <tr>
                      <th class="number-col">#</th>
                      <th class="player-col">Player</th>
                      <th class="pos-col">Pos</th>
                      <th class="stat-col">GP</th>
                      <th class="stat-col">G</th>
                      <th class="stat-col">A</th>
                      <th class="stat-col highlight-col">PTS</th>
                      <th class="stat-col">+/-</th>
                      <th class="stat-col">PIM</th>
                      <th class="stat-col">Shots</th>
                      <th class="stat-col">S%</th>
                      <th class="stat-col">Hits</th>
                      <th class="stat-col">PPG</th>
                      <th class="stat-col">SHG</th>
                      <th class="stat-col">TOI</th>
                      <th *ngIf="hasGoalies()" class="stat-col goalie-col">Saves</th>
                      <th *ngIf="hasGoalies()" class="stat-col goalie-col">SA</th>
                      <th *ngIf="hasGoalies()" class="stat-col goalie-col">SV%</th>
                      <th *ngIf="hasGoalies()" class="stat-col goalie-col">GAA</th>
                      <th *ngIf="hasGoalies()" class="stat-col goalie-col">SO</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let player of teamRoster" class="player-row">
                      <td class="number-cell">
                        <span class="jersey-number">#{{ player.number }}</span>
                      </td>
                      <td class="player-cell">
                        <div class="player-info-detailed">
                          <div class="player-name-main">{{ player.name }}</div>
                          <div class="player-badges">
                            <span *ngIf="player.rookie" class="rookie-badge">
                              <i class="fas fa-star"></i> Rookie
                            </span>
                          </div>
                        </div>
                      </td>
                      <td class="pos-cell">
                        <span class="position-badge-detailed" 
                              [style.background-color]="getPositionColor(player.position)">
                          {{ player.position }}
                        </span>
                      </td>
                      <td class="stat-cell">{{ player.games }}</td>
                      <td class="stat-cell">{{ player.goals }}</td>
                      <td class="stat-cell">{{ player.assists }}</td>
                      <td class="stat-cell highlight-cell">
                        <strong>{{ player.points }}</strong>
                      </td>
                      <td class="stat-cell" 
                          [class.positive-stat]="player.plusMinus > 0" 
                          [class.negative-stat]="player.plusMinus < 0">
                        {{ player.plusMinus > 0 ? '+' : '' }}{{ player.plusMinus }}
                      </td>
                      <td class="stat-cell">{{ player.pim }}</td>
                      <td class="stat-cell">{{ player.shots }}</td>
                      <td class="stat-cell">{{ player.shootingPercentage.toFixed(1) }}%</td>
                      <td class="stat-cell">{{ player.hits }}</td>
                      <td class="stat-cell">{{ player.ppg }}</td>
                      <td class="stat-cell">{{ player.shg }}</td>
                      <td class="stat-cell">{{ formatTimeOnIce(player.timeOnIce) }}</td>
                      
                      <!-- Goalie Stats -->
                      <td *ngIf="hasGoalies() && player.position === 'G'" class="stat-cell goalie-stat">{{ player.saves }}</td>
                      <td *ngIf="hasGoalies() && player.position === 'G'" class="stat-cell goalie-stat">{{ player.shotsAgainst }}</td>
                      <td *ngIf="hasGoalies() && player.position === 'G'" class="stat-cell goalie-stat">{{ player.savePercentage.toFixed(1) }}%</td>
                      <td *ngIf="hasGoalies() && player.position === 'G'" class="stat-cell goalie-stat">{{ player.gaa.toFixed(2) }}</td>
                      <td *ngIf="hasGoalies() && player.position === 'G'" class="stat-cell goalie-stat">{{ player.shutouts }}</td>
                      
                      <!-- Empty cells for non-goalies when goalies exist -->
                      <td *ngIf="hasGoalies() && player.position !== 'G'" class="stat-cell empty-goalie-stat">-</td>
                      <td *ngIf="hasGoalies() && player.position !== 'G'" class="stat-cell empty-goalie-stat">-</td>
                      <td *ngIf="hasGoalies() && player.position !== 'G'" class="stat-cell empty-goalie-stat">-</td>
                      <td *ngIf="hasGoalies() && player.position !== 'G'" class="stat-cell empty-goalie-stat">-</td>
                      <td *ngIf="hasGoalies() && player.position !== 'G'" class="stat-cell empty-goalie-stat">-</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>